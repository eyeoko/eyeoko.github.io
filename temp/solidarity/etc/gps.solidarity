% Goal driven Parallel Sequences -- Jos De Roo
% See background paper https://arxiv.org/pdf/2010.12027.pdf

% find paths in the state space from initial state to goal state within limits
'https://josd.github.io/ns#findpath'(_SCOPE,[Goal,Path,Duration,Cost,Belief,Comfort,Limits]) <=
    'https://josd.github.io/ns#findpaths'([],[Goal,[],0.0,0.0,1.0,1.0,Path,Duration,Cost,Belief,Comfort,Limits]).

'https://josd.github.io/ns#findpaths'(_Maps,[Goal,Path,Duration,Cost,Belief,Comfort,Path,Duration,Cost,Belief,Comfort,_Limits]) <=
    'https://josd.github.io/ns#control'(call(Goal),-),
    'https://josd.github.io/ns#control'(!,-).
'https://josd.github.io/ns#findpaths'(Maps_s,[Goal,Path_s,Duration_s,Cost_s,Belief_s,Comfort_s,Path,Duration,Cost,Belief,Comfort,Limits]) <=
    'https://josd.github.io/ns#builtin'(Limits = [MaxDuration,MaxCost,MinBelief,MinComfort,MaxStagecount],-),
    'https://josd.github.io/ns#builtin'(clause(
        'https://josd.github.io/ns#description'(Map,[From,Transition,To,Action,Duration_n,Cost_n,Belief_n,Comfort_n]),
        Where
    ),-),
    'https://josd.github.io/ns#control'(call(From),-),
    'https://josd.github.io/ns#control'(call(Where),-),
    'https://josd.github.io/ns#description'(Map,[From,Transition,To,Action,Duration_n,Cost_n,Belief_n,Comfort_n]),
    'https://josd.github.io/ns#builtin'(append(Maps_s,[Map],Maps_t),-),
    'https://josd.github.io/ns#stagecount'(Maps_t,Stagecount),
    'https://josd.github.io/ns#builtin'(Stagecount =< MaxStagecount,-),
    'https://josd.github.io/ns#builtin'(Duration_t is Duration_s+Duration_n,-),
    'https://josd.github.io/ns#builtin'(Duration_t =< MaxDuration,-),
    'https://josd.github.io/ns#builtin'(Cost_t is Cost_s+Cost_n,-),
    'https://josd.github.io/ns#builtin'(Cost_t =< MaxCost,-),
    'https://josd.github.io/ns#builtin'(Belief_t is Belief_s*Belief_n,-),
    'https://josd.github.io/ns#builtin'(Belief_t >= MinBelief,-),
    'https://josd.github.io/ns#builtin'(Comfort_t is Comfort_s*Comfort_n,-),
    'https://josd.github.io/ns#builtin'(Comfort_t >= MinComfort,-),
    'https://josd.github.io/ns#builtin'(append(Path_s,[Action],Path_t),-),
    'https://josd.github.io/ns#becomes'(From,To),
    'https://josd.github.io/ns#builtin'(call_cleanup(
        'https://josd.github.io/ns#findpaths'(Maps_t,[Goal,Path_t,Duration_t,Cost_t,Belief_t,Comfort_t,Path,Duration,Cost,Belief,Comfort,Limits]),
        'https://josd.github.io/ns#becomes'(To,From)
    ),-).

% counting the number of stages (a stage is a sequence of steps in the same map)
'https://josd.github.io/ns#stagecount'([],1).
'https://josd.github.io/ns#stagecount'([C,E|_],B) <=
    'https://josd.github.io/ns#builtin'(C \= E,-),
    'https://josd.github.io/ns#control'(!,-),
    'https://josd.github.io/ns#stagecount'(_,G),
    'https://josd.github.io/ns#builtin'(B is G+1,-).
'https://josd.github.io/ns#stagecount'([_|D],B) <=
    'https://josd.github.io/ns#stagecount'(D,B).

% linear implication
'https://josd.github.io/ns#becomes'(A,B) <=
    'https://josd.github.io/ns#control'(catch(A,_,fail),-),
    'https://josd.github.io/ns#conj_list'(A,C),
    'https://josd.github.io/ns#builtin'(forall(
        'https://josd.github.io/ns#builtin'(member(D,C),-),
        'https://josd.github.io/ns#builtin'(retract(D),-)
    ),-),
    'https://josd.github.io/ns#conj_list'(B,E),
    'https://josd.github.io/ns#builtin'(forall(
        'https://josd.github.io/ns#builtin'(member(F,E),-),
        'https://josd.github.io/ns#builtin'(assertz(F),-)
    ),-).

'https://josd.github.io/ns#conj_list'(true,[]).
'https://josd.github.io/ns#conj_list'(A,[A]) <=
    'https://josd.github.io/ns#builtin'(A \= (_,_),-),
    'https://josd.github.io/ns#builtin'(A \= false,-),
    'https://josd.github.io/ns#control'(!,-).
'https://josd.github.io/ns#conj_list'((A,B),[A|C]) <=
    'https://josd.github.io/ns#conj_list'(B,C).

% test data
'https://josd.github.io/ns#directive'(dynamic('https://josd.github.io/ns#description'/2),-).
'https://josd.github.io/ns#directive'(dynamic('https://josd.github.io/ns#location'/2),-).

% partial map of Belgium
'https://josd.github.io/ns#description'(
    'https://josd.github.io/ns#map_be',
    [   'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#gent'),
        true,
        'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#brugge'),
        'https://josd.github.io/ns#drive_gent_brugge',
        1500.0,
        0.006,
        0.96,
        0.99
    ]
).
'https://josd.github.io/ns#description'(
    'https://josd.github.io/ns#map_be',
    [   'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#gent'),
        true,
        'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#kortrijk'),
        'https://josd.github.io/ns#drive_gent_kortrijk',
        1600.0,
        0.007,
        0.96,
        0.99
    ]
).
'https://josd.github.io/ns#description'(
    'https://josd.github.io/ns#map_be',
    [   'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#kortrijk'),
        true,
        'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#brugge'),
        'https://josd.github.io/ns#drive_kortrijk_brugge',
        1600.0,
        0.007,
        0.96,
        0.99
    ]
).
'https://josd.github.io/ns#description'(
    'https://josd.github.io/ns#map_be',
    [   'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#brugge'),
        true,
        'https://josd.github.io/ns#location'(S,'https://josd.github.io/ns#oostende'),
        'https://josd.github.io/ns#drive_brugge_oostende',
        900.0,
        0.004,
        0.98,
        1.0
    ]
).

% current state
'https://josd.github.io/ns#location'('https://josd.github.io/ns#i1','https://josd.github.io/ns#gent').

% query
'https://josd.github.io/ns#findpath'(
    'https://josd.github.io/ns#map_be',
    [   'https://josd.github.io/ns#location'(_SUBJECT,'https://josd.github.io/ns#oostende'),
        _PATH,
        _DURATION,
        _COST,
        _BELIEF,
        _COMFORT,
        [5000.0,5.0,0.2,0.4,1]
    ]
) => true.
